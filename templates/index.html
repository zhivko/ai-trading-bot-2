<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Crypto Chart</title>
    <script>
        // Set the initial symbol from the server (defaults to BTCUSDT if not provided)
        window.initialSymbol = "{{ symbol|default('BTCUSDT') }}";
        console.log('[Template] Initial symbol set to:', window.initialSymbol);
    </script>
    <style>
        * {
            box-sizing: border-box;
        }
        html, body {
            height: 100%;
            margin: 0;
            overflow: hidden; /* Prevent scrolling on the body */
        }
        body {
            font-family: Arial, sans-serif;
            display: flex; 
            flex-direction: column;
        }
        #controls {
            display: flex;
            justify-content: space-around;
            padding: 10px;
            background-color: #f0f0f0;
        }
        #main {
            display: flex;
            flex: 1;
            min-height: 0; /* Important for flex-shrink to work correctly in some browsers */
        }
        #chart {
            flex-grow: 1;
            flex-basis: 0;
        }
        #right-panel {
            width: 320px;
            padding: 10px;
            background-color: #e0e0e0;
            overflow-y: auto; /* This is where the scrollbar will appear */
            font-size: 13px;
            max-height: calc(100vh - 80px); /* Constrain height to viewport minus header */
        }
        #right-panel p {
            margin: 0.5em 0; 
        }
        #event-output {
            width: 98%;
            height: 100px;
            overflow-y: auto;
            font-size: 0.9em;
            word-break: break-all;
            border: 1px solid #ccc;
            padding: 5px;
            white-space: pre-wrap;
            resize: none;
        }
        #indicator-checkbox-list div {
            margin-bottom: 5px;
        }

        /* Modal Styles */
        .modal {
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
        }

        .modal-content {
            background-color: #fefefe;
            margin: 5% auto;
            padding: 0;
            border: 1px solid #888;
            width: 90%;
            max-width: 500px;
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        }

        .modal-header {
            padding: 15px 20px;
            background-color: #f8f9fa;
            border-bottom: 1px solid #dee2e6;
            border-radius: 8px 8px 0 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-header h3 {
            margin: 0;
            color: #333;
        }

        .close-modal {
            color: #aaa;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }

        .close-modal:hover {
            color: #000;
        }

        .modal-body {
            padding: 20px;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: #555;
        }

        .form-group input,
        .form-group select {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }

        .form-group input[type="color"] {
            height: 40px;
            cursor: pointer;
        }

        .modal-footer {
            padding: 15px 20px;
            background-color: #f8f9fa;
            border-top: 1px solid #dee2e6;
            border-radius: 0 0 8px 8px;
            text-align: right;
        }

        .modal-footer button {
            padding: 8px 16px;
            margin-left: 10px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
        }

        #save-shape-properties {
            background-color: #007bff;
            color: white;
        }

        #save-shape-properties:hover {
            background-color: #0056b3;
        }

        #cancel-shape-properties {
            background-color: #6c757d;
            color: white;
        }

        #cancel-shape-properties:hover {
            background-color: #545b62;
        }
    </style>
</head>
<body>
    <div id="controls">
  <div>
    <strong>Crypto Pair:</strong>
    <select id="symbol-select">
    </select>
    </div>
  
  <div>
    <strong>Time Scale:</strong>
    <select id="resolution-select">
    </select>
  </div>
  
  <div>
    <strong>Time Range:</strong>
    <select id="range-select">
    </select>
 </div>

  <div>
    {% if request.session.email %}
      Logged in as: {{ request.session.email }}
      <button onclick="window.location.href='/logout'" style="margin-left: 10px; background: none; border: 1px solid #007bff; color: #007bff; padding: 5px 10px; cursor: pointer; border-radius: 4px;">↗️ Log out</button>
    {% endif %}
  </div>

</div>
    <div id="main">
        <div id="chart"></div>
        <div id="right-panel">
            <h3>Right Panel</h3>
            <div>
                <strong>Live Data:</strong> Always Enabled
            </div>

            <hr>
            <div id="replay-section">
   <h4>Replay Controls</h4>
                <label>From: <input type="date" id="replay-from" {% if not authenticated %} disabled {% endif %}></label><br>
                <label>To: <input type="date" id="replay-to" {% if not authenticated %} disabled {% endif %}></label><br>
                <label>Speed (candle/sec): <input type="number" id="replay-speed" value="1" min="0.1" step="0.1" {% if not authenticated %} disabled {% endif %}></label><br>
                <input type="checkbox" id="use-local-ollama-checkbox" />
                <label for="use-local-ollama-checkbox">Use local Ollama</label><br>
                <div id="local-ollama-model-selection-div" style="display: none;">
                    <label for="local-ollama-model-select" style="display: block; margin-bottom: 2px;">Select Local Model:</label>
                    <select id="local-ollama-model-select" style="width: 50%; margin-bottom: 5px;"></select><br>
                </div>                
                <button id="ai-suggestion-btn" {% if not authenticated %} disabled {% endif %}>Get AI Suggestion</button><br>
                <button id="start-replay" {% if not authenticated %} disabled {% endif %}>Start</button> <button id="stop-replay" {% if not authenticated %} disabled {% endif %}></button><br>
                <textarea id="ai-suggestion" placeholder="AI suggestion..." style="width: 95%; height: 90px;" {% if not authenticated %} disabled {% endif %}></textarea>
            </div>

            <p>Additional controls or data display can go here.</p>
            <hr>
            <h4>Chart View State:</h4>
            <p><strong>X-Axis Min:</strong> <span id="x-axis-min-display">Auto</span></p>
            <p><strong>X-Axis Max:</strong> <span id="x-axis-max-display">Auto</span></p>
            <p><strong>Y-Axis Min:</strong> <span id="y-axis-min-display">Auto</span></p>
            <p><strong>Y-Axis Max:</strong> <span id="y-axis-max-display">Auto</span></p>
            <hr>
            <h4>Selected Shape:</h4>
            <div id="selected-shape-info">
                <p>No shape selected.</p>
            </div>
            <div>
                <button id="edit-shape-btn" style="display: none;">Edit line</button>
                <button id="delete-shape-btn" style="display: none;">Delete line</button>
                <button id="delete-all-shapes-btn">Delete ALL Drawings</button>
            </div>
            <hr>
            <h4>Cursor Info:</h4>
            <p><strong>Price:</strong> <span id="cursor-price-display">N/A</span></p>
            <p><strong>Time:</strong> <span id="cursor-time-display">N/A</span></p>
            <hr>
            <h4>Event Log:</h4>
            <textarea id="event-output" readonly></textarea>
            <hr>
            <div class="form-check">
                <input class="form-check-input" type="checkbox" id="showAgentTradesCheckbox">
                <label class="form-check-label" for="showAgentTradesCheckbox">
                    Show Agent Trades
                </label>
            </div>
            <h4>Indicators:</h4>
            <div id="indicator-checkbox-list">
                <div>
                    <input type="checkbox" id="indicator-macd" value="macd">
                    <label for="indicator-macd">Macd</label>
                </div>
                <div>
                    <input type="checkbox" id="indicator-rsi" value="rsi">
                    <label for="indicator-rsi">RSI</label>
                </div>
                <div>
                    <input type="checkbox" id="indicator-stoch-rsi-9-3" value="stochrsi_9_3">
                    <label for="indicator-stoch-rsi-9-3">Stochastic RSI 9,3</label>
                </div>
                <div>
                    <input type="checkbox" id="indicator-stoch-rsi-14-3" value="stochrsi_14_3">
                    <label for="indicator-stoch-rsi-14-3">Stochastic RSI 14,3</label>
                </div>
                <div>
                    <input type="checkbox" id="indicator-stoch-rsi-40-4" value="stochrsi_40_4">
                    <label for="indicator-stoch-rsi-40-4">Stochastic RSI 40,4</label>
                </div>
                <div>
                    <input type="checkbox" id="indicator-stoch-rsi-60-10" value="stochrsi_60_10">
                    <label for="indicator-stoch-rsi-60-10">Stochastic RSI 60,10</label>
                </div>
                <div class="indicator-item">
                    <input type="checkbox" id="indicator-open_interest" value="open_interest">
                    <label for="indicator-open_interest">Open Interest</label>
                </div>                
                <div>
                    <input type="checkbox" id="indicator-jma" value="jma">
                    <label for="indicator-jma">Jurik MA</label>
                </div>
            </div>
        </div>
    </div>

    <div id="shape-properties-dialog" style="display:none; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background-color: white; padding: 20px; border: 1px solid black; z-index: 1000;">
        <h3>Shape Properties</h3>
        <p><strong>ID:</strong> <span id="shape-id-display"></span></p>
        <label for="buy-on-cross">Buy on Cross:</label>
        <input type="checkbox" id="buy-on-cross"><br><br>

        <label for="sell-on-cross">Sell on Cross:</label>
        <input type="checkbox" id="sell-on-cross"><br><br>

        <label for="amount">Amount:</label>
        <input type="number" id="amount"><br><br>

        <label for="send-email-on-cross">Send an email on cross:</label>
        <input type="checkbox" id="send-email-on-cross"><br><br>


        <label for="email-sent">Email Sent:</label>
        <input type="checkbox" id="email-sent"><br><br>

        <label for="email-date">Email Date:</label>
        <span id="email-date-display">Not sent yet</span><br><br>

        <button onclick="saveShapeProperties()">Save</button>
        <button onclick="closeShapePropertiesDialog()">Cancel</button>
    </div>

    <!-- <script src="/static/plotly-2.22.0.js"></script> -->
    <script src="https://cdn.plot.ly/plotly-2.35.2.min.js" charset="utf-8"></script>
    <!-- External JavaScript files -->
    <!-- Core utilities and API functions first -->
    <script src="/static/js/config.js?v=2"></script>
    <script src="/static/js/state.js"></script>
    <script src="/static/js/utils.js"></script>
    <script src="/static/js/api.js"></script>       <!-- Ensure api.js is loaded before scripts that depend on it -->
    
    <!-- Scripts that depend on core utilities and API functions -->
    <script src="/static/js/combinedData.js"></script>
    <script src="/static/js/uiUpdaters.js"></script> <!-- Moved up to define updateShapeVisuals before chartInteractions -->
    <script src="/static/js/chartInteractions.js"></script>
    <script src="/static/js/aiFeatures.js"></script>
    <script src="/static/js/replay.js"></script>
    <script src="/static/js/settingsManager.js"></script>
    <script src="/static/js/plotlyEventHandlers.js"></script>

    <!-- Main application logic last - This should be fine if dependent logic is within functions -->
    <script src="/static/js/main.js"></script>
</body>
</html>
