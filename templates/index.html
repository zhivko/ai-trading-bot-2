<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Crypto Chart</title>
    <script>
        // Set the initial symbol from the server (defaults to BTCUSDT if not provided)
        window.initialSymbol = "{{ symbol|default('BTCUSDT') }}";
        console.log('[Template] Initial symbol set to:', window.initialSymbol);
    </script>
    <style>
        * {
            box-sizing: border-box;
        }
        html, body {
            height: 100%;
            margin: 0;
            overflow: hidden; /* Prevent scrolling on the body */
        }
        body {
            font-family: Arial, sans-serif;
            display: flex; 
            flex-direction: column;
        }
        #controls {
            display: flex;
            justify-content: space-around;
            padding: 10px;
            background-color: #f0f0f0;
        }
        #main {
            display: flex;
            flex: 1;
            min-height: 0; /* Important for flex-shrink to work correctly in some browsers */
        }
        #chart {
            flex-grow: 1;
            flex-basis: 0;
            touch-action: none; /* Enable pinch-to-zoom on mobile devices */
        }
        #right-panel {
            width: 320px;
            padding: 10px;
            background-color: #e0e0e0;
            overflow-y: auto; /* This is where the scrollbar will appear */
            font-size: 13px;
            max-height: calc(100vh - 80px); /* Constrain height to viewport minus header */
        }

        /* Custom Toolbar Styles */
        .custom-toolbar {
            display: flex;
            justify-content: space-around;
            background-color: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            padding: 8px;
            margin-bottom: 15px;
            flex-wrap: wrap;
            gap: 5px;
        }

        .toolbar-button {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 32px;
            height: 32px;
            border: 1px solid #ccc;
            border-radius: 4px;
            background-color: white;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 14px;
        }

        .toolbar-button:hover {
            background-color: #e9ecef;
            border-color: #adb5bd;
        }

        .toolbar-button.active {
            background-color: #007bff;
            border-color: #007bff;
            color: white;
        }

        .toolbar-button svg {
            width: 16px;
            height: 16px;
        }
        #right-panel p {
            margin: 0.5em 0; 
        }
        #event-output {
            width: 98%;
            height: 100px;
            overflow-y: auto;
            font-size: 0.9em;
            word-break: break-all;
            border: 1px solid #ccc;
            padding: 5px;
            white-space: pre-wrap;
            resize: none;
        }
        #indicator-checkbox-list div {
            margin-bottom: 5px;
        }

        /* Audio Recording Styles */
        .audio-section {
            border: 1px solid #ccc;
            padding: 10px;
            margin: 10px 0;
            background-color: #f9f9f9;
            border-radius: 5px;
        }

        .audio-section h4 {
            margin: 0 0 10px 0;
            color: #333;
        }

        .record-button {
            background-color: #28a745;
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            width: 100%;
            margin-bottom: 10px;
            transition: background-color 0.3s;
        }

        .record-button:hover:not(:disabled) {
            background-color: #218838;
        }

        .record-button.recording {
            background-color: #dc3545;
            animation: pulse 1s infinite;
        }

        .record-button.recording:hover {
            background-color: #c82333;
        }

        .record-button:disabled {
            background-color: #6c757d;
            cursor: not-allowed;
        }

        .audio-status {
            font-size: 12px;
            margin-bottom: 10px;
            padding: 5px;
            border-radius: 3px;
            text-align: center;
        }

        .audio-status.recording {
            background-color: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }

        .audio-status.processing {
            background-color: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }

        .audio-status.success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .audio-status.error {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .transcription-result {
            background-color: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 5px;
            padding: 10px;
            margin-top: 10px;
            display: none;
        }

        .transcription-header {
            font-size: 14px;
            margin-bottom: 5px;
        }

        .transcription-text {
            font-style: italic;
            margin: 5px 0;
            color: #495057;
        }

        .transcription-meta {
            font-size: 12px;
            color: #6c757d;
            margin-top: 5px;
        }

        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.7; }
            100% { opacity: 1; }
        }

        /* Modal Styles */
        .modal {
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
        }

        .modal-content {
            background-color: #fefefe;
            margin: 5% auto;
            padding: 0;
            border: 1px solid #888;
            width: 90%;
            max-width: 500px;
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        }

        .modal-header {
            padding: 15px 20px;
            background-color: #f8f9fa;
            border-bottom: 1px solid #dee2e6;
            border-radius: 8px 8px 0 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-header h3 {
            margin: 0;
            color: #333;
        }

        .close-modal {
            color: #aaa;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }

        .close-modal:hover {
            color: #000;
        }

        .modal-body {
            padding: 20px;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: #555;
        }

        .form-group input,
        .form-group select {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }

        .form-group input[type="color"] {
            height: 40px;
            cursor: pointer;
        }

        .modal-footer {
            padding: 15px 20px;
            background-color: #f8f9fa;
            border-top: 1px solid #dee2e6;
            border-radius: 0 0 8px 8px;
            text-align: right;
        }

        .modal-footer button {
            padding: 8px 16px;
            margin-left: 10px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
        }

        #save-shape-properties {
            background-color: #007bff;
            color: white;
        }

        #save-shape-properties:hover {
            background-color: #0056b3;
        }

        #cancel-shape-properties {
            background-color: #6c757d;
            color: white;
        }

        #cancel-shape-properties:hover {
            background-color: #545b62;
        }
    </style>
</head>
<body>
    <div id="controls">
  <div>
    <strong>Crypto Pair:</strong>
    <select id="symbol-select">
    </select>
    </div>
  
  <div>
    <strong>Time Scale:</strong>
    <select id="resolution-select">
    </select>
  </div>
  
  <div>
    <strong>Time Range:</strong>
    <select id="range-select">
    </select>
 </div>

  <div>
    {% if request.session.email %}
      Logged in as: {{ request.session.email }}
      <button onclick="window.location.href='/logout'" style="margin-left: 10px; background: none; border: 1px solid #007bff; color: #007bff; padding: 5px 10px; cursor: pointer; border-radius: 4px;">↗️ Log out</button>
    {% endif %}
  </div>

</div>
    <div id="main">
        <div id="chart"></div>
        <div id="right-panel">
            <!-- Custom Toolbar -->
            <div class="custom-toolbar">
                <button id="pan-btn" class="toolbar-button" title="Pan: Click and drag to move the chart view">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M20 9v11a2 2 0 01-2 2H6a2 2 0 01-2-2V9"/>
                        <path d="M9 12l2 2 4-4"/>
                        <path d="M21 9H3l9-7 9 7z"/>
                    </svg>
                </button>
                <button id="drawline-btn" class="toolbar-button" title="Draw Line: Click and drag to draw trend lines on the chart">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M12 19l7-7 3 3-7 7-3-3z"/>
                        <path d="M18 13l-1.5-7.5L2 2l3.5 14.5L13 18l5-5z"/>
                        <path d="M2 2l7.586 7.586"/>
                        <circle cx="11" cy="11" r="2"/>
                    </svg>
                </button>
                <button id="screenshot-btn" class="toolbar-button" title="Take Screenshot: Download the current chart as PNG image">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4"/>
                        <polyline points="7,10 12,15 17,10"/>
                        <line x1="12" y1="15" x2="12" y2="3"/>
                    </svg>
                </button>
                <button id="autoscale-btn" class="toolbar-button" title="Auto Scale: Automatically adjust chart zoom to show all data">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <circle cx="11" cy="11" r="8"/>
                        <path d="M21 21l-4.35-4.35"/>
                        <line x1="13" y1="9" x2="9" y2="13"/>
                        <line x1="15" y1="11" x2="11" y2="15"/>
                    </svg>
                </button>
            </div>

            <h3>Right Panel</h3>
            <div>
                <strong>Live Data:</strong> Always Enabled
            </div>

            <hr>
            <div id="replay-section">
   <h4>Replay Controls</h4>
                <label>From: <input type="date" id="replay-from" {% if not authenticated %} disabled {% endif %}></label><br>
                <label>To: <input type="date" id="replay-to" {% if not authenticated %} disabled {% endif %}></label><br>
                <label>Speed (candle/sec): <input type="number" id="replay-speed" value="1" min="0.1" step="0.1" {% if not authenticated %} disabled {% endif %}></label><br>
                <input type="checkbox" id="use-local-ollama-checkbox" />
                <label for="use-local-ollama-checkbox">Use local Ollama</label><br>
                <div id="local-ollama-model-selection-div" style="display: none;">
                    <label for="local-ollama-model-select" style="display: block; margin-bottom: 2px;">Select Local Model:</label>
                    <select id="local-ollama-model-select" style="width: 50%; margin-bottom: 5px;"></select><br>
                </div>                
                <button id="ai-suggestion-btn" {% if not authenticated %} disabled {% endif %}>Get AI Suggestion</button><br>
                <button id="start-replay" {% if not authenticated %} disabled {% endif %}>Start</button> <button id="stop-replay" {% if not authenticated %} disabled {% endif %}></button><br>
                <textarea id="ai-suggestion" placeholder="AI suggestion..." style="width: 95%; height: 90px;" {% if not authenticated %} disabled {% endif %}></textarea>
            </div>

            <p>Additional controls or data display can go here.</p>
            <hr>
            <h4>Chart View State:</h4>
            <p><strong>X-Axis Min:</strong> <span id="x-axis-min-display">Auto</span></p>
            <p><strong>X-Axis Max:</strong> <span id="x-axis-max-display">Auto</span></p>
            <p><strong>Y-Axis Min:</strong> <span id="y-axis-min-display">Auto</span></p>
            <p><strong>Y-Axis Max:</strong> <span id="y-axis-max-display">Auto</span></p>
            <hr>
            <h4>Selected Shape:</h4>
            <div id="selected-shape-info">
                <p>No shape selected.</p>
            </div>
            <div>
                <button id="edit-shape-btn" style="display: none;">Edit line</button>
                <button id="delete-shape-btn" style="display: none;">Delete line</button>
                <button id="delete-all-shapes-btn">Delete ALL Drawings</button>
            </div>
            <hr>
            <h4>Cursor Info:</h4>
            <p><strong>Price:</strong> <span id="cursor-price-display">N/A</span></p>
            <p><strong>Time:</strong> <span id="cursor-time-display">N/A</span></p>
            <hr>
            <div class="audio-section">
                <h4>🎤 Audio Recording</h4>
                <button id="record-button" class="record-button">🎤 Start Recording</button>
                <div id="audio-status" class="audio-status">Ready to record</div>
                <div id="transcription-result" class="transcription-result">
                    <!-- Transcription results will be displayed here -->
                </div>
            </div>
            <hr>
            <h4>Event Log:</h4>
            <textarea id="event-output" readonly></textarea>
            <hr>
            <div class="form-check">
                <input class="form-check-input" type="checkbox" id="showAgentTradesCheckbox">
                <label class="form-check-label" for="showAgentTradesCheckbox">
                    Show Agent Trades
                </label>
            </div>
            <h4>Indicators:</h4>
            <div id="indicator-checkbox-list">
                <div>
                    <input type="checkbox" id="indicator-macd" value="macd">
                    <label for="indicator-macd">Macd</label>
                </div>
                <div>
                    <input type="checkbox" id="indicator-rsi" value="rsi">
                    <label for="indicator-rsi">RSI</label>
                </div>
                <div>
                    <input type="checkbox" id="indicator-stoch-rsi-9-3" value="stochrsi_9_3">
                    <label for="indicator-stoch-rsi-9-3">Stochastic RSI 9,3</label>
                </div>
                <div>
                    <input type="checkbox" id="indicator-stoch-rsi-14-3" value="stochrsi_14_3">
                    <label for="indicator-stoch-rsi-14-3">Stochastic RSI 14,3</label>
                </div>
                <div>
                    <input type="checkbox" id="indicator-stoch-rsi-40-4" value="stochrsi_40_4">
                    <label for="indicator-stoch-rsi-40-4">Stochastic RSI 40,4</label>
                </div>
                <div>
                    <input type="checkbox" id="indicator-stoch-rsi-60-10" value="stochrsi_60_10">
                    <label for="indicator-stoch-rsi-60-10">Stochastic RSI 60,10</label>
                </div>
                <div class="indicator-item">
                    <input type="checkbox" id="indicator-open_interest" value="open_interest">
                    <label for="indicator-open_interest">Open Interest</label>
                </div>                
                <div>
                    <input type="checkbox" id="indicator-jma" value="jma">
                    <label for="indicator-jma">Jurik MA</label>
                </div>
            </div>
        </div>
    </div>

    <div id="shape-properties-dialog" style="display:none; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background-color: white; padding: 20px; border: 1px solid black; z-index: 1000;">
        <h3>Shape Properties</h3>
        <p><strong>ID:</strong> <span id="shape-id-display"></span></p>

        <!-- Y Value Editing Section -->
        <div style="border: 1px solid #ccc; padding: 10px; margin: 10px 0; background-color: #f9f9f9;">
            <h4>Y Values</h4>
            <label for="start-price">Start Price (Y1):</label>
            <input type="number" id="start-price" step="0.00000001" style="width: 100%; margin-bottom: 5px;"><br>

            <label for="end-price">End Price (Y2):</label>
            <input type="number" id="end-price" step="0.00000001" style="width: 100%;"><br>
        </div>

        <label for="buy-on-cross">Buy on Cross:</label>
        <input type="checkbox" id="buy-on-cross"><br><br>

        <label for="sell-on-cross">Sell on Cross:</label>
        <input type="checkbox" id="sell-on-cross"><br><br>

        <label for="amount">Amount:</label>
        <input type="number" id="amount"><br><br>

        <label for="send-email-on-cross">Send an email on cross:</label>
        <input type="checkbox" id="send-email-on-cross"><br><br>


        <label for="email-sent">Email Sent:</label>
        <input type="checkbox" id="email-sent"><br><br>

        <label for="email-date">Email Date:</label>
        <span id="email-date-display">Not sent yet</span><br><br>

        <button onclick="saveShapeProperties()">Save</button>
        <button onclick="closeShapePropertiesDialog()">Cancel</button>
    </div>

    <!-- <script src="/static/plotly-2.22.0.js"></script> -->
    <script src="https://cdn.plot.ly/plotly-2.35.2.min.js" charset="utf-8"></script>
    <!-- External JavaScript files -->
    <!-- Core utilities and API functions first -->
    <script src="/static/js/config.js?v=2"></script>
    <script src="/static/js/state.js"></script>
    <script src="/static/js/utils.js"></script>
    <script src="/static/js/api.js"></script>       <!-- Ensure api.js is loaded before scripts that depend on it -->
    
    <!-- Scripts that depend on core utilities and API functions -->
    <script src="/static/js/combinedData.js"></script>
    <script src="/static/js/uiUpdaters.js"></script> <!-- Moved up to define updateShapeVisuals before chartInteractions -->
    <script src="/static/js/chartInteractions.js"></script>
    <script src="/static/js/aiFeatures.js"></script>
    <script src="/static/js/replay.js"></script>
    <script src="/static/js/settingsManager.js"></script>
    <script src="/static/js/plotlyEventHandlers.js"></script>

    <!-- Audio recording functionality -->
    <script src="/static/js/audioRecording.js"></script>

    <!-- YouTube markers integration -->
    <script src="/static/js/youtubeMarkers.js"></script>

    <!-- Main application logic last - This should be fine if dependent logic is within functions -->
    <script src="/static/js/main.js"></script>
</body>
</html>
